<% extend("../../admin.ejs") %>
<div class="pcoded-content">
    <div class="pcoded-inner-content">
        <div class="main-body">
            <div class="page-wrapper">
                <!-- Page-header start -->
                <div class="page-header card">
                    <div class="row align-items-end">
                        <div class="col-lg-8">
                            <div class="page-header-title">
                                <i class="icofont icofont-file-code bg-c-blue"></i>
                                <div class="d-inline">
                                    <h4> Chỉnh sửa sản phẩm </h4>
                                    <span>Lorem ipsum dolor sit <code>amet</code>, consectetur adipisicing elit</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-4">
                            <div class="page-header-breadcrumb">
                                <ul class="breadcrumb-title">
                                    <li class="breadcrumb-item">
                                        <a href="index.html">
                                            <i class="icofont icofont-home"></i>
                                        </a>
                                    </li>
                                    <li class="breadcrumb-item"><a href="/admin">Trang chủ</a>
                                    </li>
                                    <li class="breadcrumb-item"><a href="/admin/products">Danh sách sản phẩm</a>
                                    </li>
                                    <li class="breadcrumb-item"><%= title %>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Page-header end -->
                <div class="page-body">
                    <div class="row">
                        <div class="col-md-12 col-xl-9">
                            <div class="card">
                                <div class="card-header">
                                    <h3> <Strong> <%= title %> </Strong></h3>
                                    <span> Chỉnh sửa thông tin sản phẩm </span>
                                    <div class="card-header-right">
                                        <ul class="list-unstyled card-option">
                                            <li><i class="icofont icofont-simple-left "></i></li>
                                            <li><i class="icofont icofont-maximize full-card"></i></li>
                                            <li><i class="icofont icofont-minus minimize-card"></i></li>
                                            <li><i class="icofont icofont-refresh reload-card"></i></li>
                                            <li><i class="icofont icofont-error close-card"></i></li>
                                        </ul>
                                    </div>
                                </div>
                                <div class="card-block table-border-style mt-2">
                                    <!-- start product images -->
                                    <div class="col-sm-12 col-xl-12">
                                        <div class="row">
                                            <% if(images_count != 0){ %>
                                            <% for (var i = 0; i < images_count; i++ ) { %>
                                            <div class="col-xs-12 col-sm-4 col-md-3">
                                                <div class="card">
                                                    <img class="card-img-top" id="image_<%= product.id %>_<%= i %>"
                                                        src="/public/uploads/products/<%= images[i] %>"
                                                        alt="Card image cap" data-index='<%= i %>'>
                                                    <div class="card-body">
                                                        <p class="text-center"> <strong> Hình ảnh
                                                                <%= i + 1 %>
                                                            </strong> </p>
                                                        <div class="btn-group" role="group" aria-label="Basic example">
                                                            <button type="button"
                                                                class="btn btn-warning edit-product-image"
                                                                title="Sửa hình ảnh" data-toggle="modal"
                                                                data-id="image_<%= product.id %>_<%= i %>"
                                                                data-url="/admin/product/edit-product-image/<%= product.id %>?index=<%= i %>"
                                                                data-target="#image-edit-modal">
                                                                <i class="icofont icofont-edit"></i>
                                                            </button>
                                                            <a href="/admin/product/delete-product-image/<%= product.id%>?index=<%= i %>"
                                                                type="button" class="btn btn-danger"
                                                                title="Xóa hình ảnh">
                                                                <i class="icofont icofont-ui-delete"></i>
                                                            </a>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <% } %>
                                            <% }else{ %>
                                            <div class="col-xs-12 col-sm-12 col-md-12">
                                                <div class="alert alert-info" role="alert">
                                                    Chưa có hình ảnh !
                                                </div>
                                            </div>
                                            <% } %>
                                        </div>
                                        <!-- <button type="button" class="btn btn-info show-image-add mb-4"
                                            data-toggle="modal" data-target="#product-image-edit" title="Thêm hình ảnh">
                                            <i class="icofont icofont-plus"></i>
                                            Thêm
                                            hình ảnh
                                        </button> -->
                                    </div>
                                    <!-- end product images  -->
                                    <!-- start add product images -->
                                    <div class="col-xs-12 col-sm-12 col-md-12">
                                        <div id="actions" class="row mb-4">
                                            <div class="col-lg-7">
                                                <div class="control-button d-flex">
                                                    <!-- The fileinput-button span is used to style the file input field as button -->
                                                    <span class="btn mr-2 btn-success fileinput-button dz-clickable">
                                                        <i class="glyphicon glyphicon-plus"></i>
                                                        <span><i class="icofont icofont-plus-circle"></i>&nbsp;Thêm
                                                            Ảnh...</span>
                                                    </span>
                                                    <button type="submit" class="btn btn-primary mr-2 start">
                                                        <i class="glyphicon glyphicon-upload"></i>
                                                        <span><i class="icofont icofont-upload"></i>&nbsp;Upload
                                                            tất
                                                            cả</span>
                                                    </button>
                                                    <button type="reset" class="btn btn-warning cancel" disabled>
                                                        <i class="glyphicon glyphicon-ban-circle"></i>
                                                        <span><i class="icofont icofont-ui-remove">&nbsp;</i>Hủy
                                                            tất
                                                            cả</span>
                                                    </button>
                                                </div>
                                            </div>
                                            <div class="col-lg-5">
                                                <!-- The global file processing state -->
                                                <span class="fileupload-process">
                                                    <div id="total-progress" class="progress progress-striped active"
                                                        role="progressbar" aria-valuemin="0" aria-valuemax="100"
                                                        aria-valuenow="0" style="opacity: 0;">
                                                        <div class="progress-bar progress-bar-success"
                                                            style="width: 100%;" data-dz-uploadprogress="">
                                                        </div>
                                                    </div>
                                                </span>
                                            </div>
                                        </div>
                                        <!-- HTML heavily inspired by http://blueimp.github.io/jQuery-File-Upload/ -->
                                        <div class="table table-striped" class="files" id="previews">
                                            <div class="template file-row d-flex">
                                                <!-- This is used as the file preview template -->
                                                <div class="flex-1">
                                                    <span class="preview"><img data-dz-thumbnail /></span>
                                                </div>
                                                <div class="flex-1">
                                                    <p class="name" data-dz-name></p>
                                                    <strong class="error text-danger" data-dz-errormessage></strong>
                                                </div>
                                                <div class="flex-1">
                                                    <p class="size" data-dz-size></p>
                                                    <div class="progress progress-striped active" role="progressbar"
                                                        aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
                                                        <div class="progress-bar progress-bar-success" style="width:0%;"
                                                            data-dz-uploadprogress></div>
                                                    </div>
                                                </div>
                                                <div class="flex-3">
                                                    <button class="btn btn-primary start">
                                                        <i class="glyphicon glyphicon-upload"></i>
                                                        <span>Lưu</span>
                                                    </button>
                                                    <button data-dz-remove class="btn btn-warning cancel">
                                                        <i class="glyphicon glyphicon-ban-circle"></i>
                                                        <span>Hủy</span>
                                                    </button>
                                                    <button data-dz-remove class="btn btn-danger delete">
                                                        <i class="glyphicon glyphicon-trash"></i>
                                                        <span>Xóa</span>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- end add product image -->
                                    <!-- start add product info -->
                                    <div class="col-md-12 col-xl-12">
                                        <form action="/admin/product/edit-product/<%= product.id %>"
                                            id="product-edit-form" method="POST" enctype="multipart/form-data">
                                            <div class="row">
                                                <div class="col-xs-12 col-sm-12 col-md-12">
                                                    <div class="form-group">
                                                        <input type="hidden" name="image_path" id="image_path"
                                                            class="form-control" placeholder="Đường dẫn sản phẩm">
                                                    </div>
                                                    <div class="form-group">
                                                        <input type="hidden" name="product_attributes_type02"
                                                            id="product_attributes_type02" class="form-control"
                                                            placeholder="">
                                                    </div>
                                                    <div class="form-group">
                                                        <input type="hidden" name="product_attributes_type01"
                                                            id="product_attributes_type01" value="<%= idtype01Arr %>"
                                                            class="form-control" placeholder="">
                                                    </div>
                                                    <div class="form-group">
                                                        <input type="hidden" name="product_attributes_valuetype01"
                                                            id="product_attributes_valuetype01"
                                                            class="form-control" placeholder="">
                                                    </div>
                                                    <div class="form-group">
                                                        <label class="font-weight-bold required-form" for="product_sku">
                                                            Sku
                                                        </label>
                                                        <input type="text" value="<%= product.sku %>" name="product_sku"
                                                            id="product_sku" class="form-control" placeholder="Sku"
                                                            required>
                                                        <small> Sku tương tự như mã sản phẩm </small>
                                                    </div>
                                                    <div class="form-group">
                                                        <label class="font-weight-bold" for="product_brand">
                                                            Thương
                                                            Hiệu
                                                        </label>
                                                        <select class="form-control custom-select" name="product_brand"
                                                            id="product_brand">
                                                            <% brands.forEach(function(brand, index){ %>
                                                            <% if(product.brand_id == brand.id ){%>
                                                            <option value="<%= brand.id %>" selected>
                                                                <%= brand.name %>
                                                            </option>
                                                            <%}else {%>
                                                            <option value="<%= brand.id %>">
                                                                <%= brand.name %>
                                                            </option>
                                                            <%}%>
                                                            <%})%>
                                                        </select>
                                                    </div>
                                                    <div class="form-group">
                                                        <label class="font-weight-bold" for="product_categories">
                                                            Danh mục
                                                        </label>
                                                        <div class="categogy-border">
                                                            <% categories.forEach(function(category, index){ %>
                                                            <% if(product.category_id == category.id ){%>
                                                            <div class="form-check">
                                                                <input type="radio" name="product_category"
                                                                    id="<%= category.id %>" class="form-check-input"
                                                                    value="<%= category.id %>" checked>
                                                                <label class="form-check-label"
                                                                    for="<%= category.id %>"><%= category.category_name %></label>
                                                            </div>
                                                            <%}else {%>
                                                            <div class="form-check">
                                                                <input type="radio" name="product_category"
                                                                    id="<%= category.id %>" class="form-check-input"
                                                                    value="<%= category.id %>">
                                                                <label class="form-check-label"
                                                                    for="<%= category.id %>"><%= category.category_name %></label>
                                                            </div>
                                                            <%}%>
                                                            <%})%>
                                                        </div>
                                                    </div>
                                                    <div class="form-group">
                                                        <label class="font-weight-bold required-form"
                                                            for="product_name">
                                                            Tên Sản Phẩm
                                                        </label>
                                                        <input type="text" name="product_name"
                                                            value="<%= product.name %>" class="form-control"
                                                            placeholder="Tên sản phẩm">
                                                    </div>
                                                    <div class="form-group">
                                                        <label class="font-weight-bold" for="product_slug">
                                                            Đường dẫn slug
                                                        </label>
                                                        <input type="text" name="product_slug" id="product_slug"
                                                            value="<%= product.slug %>" class="form-control"
                                                            placeholder="Tên sản phẩm" required>
                                                        <small> Slug, đường dẫn tối ưu SEO </small>
                                                    </div>
                                                    <div class="form-group">
                                                        <label class="font-weight-bold required-form"
                                                            for="product_price">
                                                            Giá sản phẩm
                                                        </label>
                                                        <input type="text" name="product_price"
                                                            value="<%= product.price %>" id="product_price"
                                                            class="form-control" placeholder="giá sản phẩm">
                                                    </div>
                                                    <div class="form-group">
                                                        <label class="font-weight-bold" for="product_quantity"> Số
                                                            lượng </label>
                                                        <input type="text" name="product_quantity"
                                                            value="<%= product.quantity %>" id="product_quantity"
                                                            class="form-control" placeholder="Số lượng">
                                                    </div>
                                                    <div class="form-group">
                                                        <label class="font-weight-bold" for="propduct_description">
                                                            Mô tả
                                                        </label>
                                                        <textarea id="summernote" name="propduct_description">
                                                            <%- product.description %> 
                                                        </textarea>
                                                    </div>
                                                    <div class="form-group">
                                                        <label class="font-weight-bold" for="short_description">
                                                            Mô tả ngắn </label>
                                                        <input type="text" name="short_description"
                                                            id="short_description" class="form-control"
                                                            placeholder="Mô tả ngắn">
                                                    </div>
                                                </div>
                                                <!-- col end  -->
                                            </div>
                                            <div class="row">
                                                <div class="col-sm-12 mt-4">
                                                    <h4 class="sub-title"> Dữ liệu sản phẩm </h4>
                                                    <ul class="nav nav-tabs md-tabs tabs-left b-none" role="tablist">
                                                        <li class="nav-item">
                                                            <a class="nav-link active" data-toggle="tab" href="#seotab"
                                                                role="tab"> <strong>Seo
                                                                    website</strong></a>
                                                            <div class="slide"></div>
                                                        </li>
                                                        <li class="nav-item">
                                                            <a class="nav-link" data-toggle="tab" href="#techinfotab"
                                                                role="tab">
                                                                <strong>Thuộc tính kỹ
                                                                    thuật</strong> </a>
                                                            <div class="slide"></div>
                                                        </li>
                                                    </ul>
                                                    <!-- Tab panes -->
                                                    <div class="tab-content tabs-left-content card-block">
                                                        <div class="tab-pane active" id="seotab" role="tabpanel">
                                                            <div class="form-group">
                                                                <label class="font-weight-bold"
                                                                    for="product_meta_title">
                                                                    Meta title </label>
                                                                <input type="text" name="product_meta_title"
                                                                    id="product_meta_title"
                                                                    value="<%= product.meta_title %>"
                                                                    class="form-control" placeholder="Thẻ meta-title">
                                                                <small class="text-muted"> Thẻ meta title
                                                                    dùng để
                                                                    tối ưu hóa SEO
                                                                </small>
                                                            </div>
                                                            <div class="form-group">
                                                                <label class="font-weight-bold"
                                                                    for="product_meta_keyword">
                                                                    Thẻ Meta keyswords </label>
                                                                <input type="text" name="product_meta_keyword"
                                                                    id="product_meta_keyword"
                                                                    value="<%= product.meta_keywords %>"
                                                                    class="form-control"
                                                                    placeholder="Thẻ meta keywords">
                                                                <small class="text-muted"> Thẻ meta keywords
                                                                    dùng để
                                                                    tối ưu hóa
                                                                    SEO
                                                                </small>
                                                            </div>
                                                            <div class="form-group">
                                                                <label class="font-weight-bold"
                                                                    for="product_meta_description">
                                                                    Thẻ Meta description </label>
                                                                <input type="text" name="product_meta_description"
                                                                    id="product_meta_description"
                                                                    value="<%= product.meta_description %>"
                                                                    class="form-control"
                                                                    placeholder="Thẻ meta keywords">
                                                                <small class="text-muted"> Thẻ meta
                                                                    description dùng
                                                                    để tối ưu
                                                                    hóa SEO
                                                                </small>
                                                            </div>
                                                        </div>
                                                        <div class="tab-pane" id="techinfotab" role="tabpanel">
                                                            <div class="form-group row">
                                                                <label class="col-sm-2 col-form-label">Thuộc
                                                                    tính</label>
                                                                <div class="col-sm-8">
                                                                    <select name="select_attribute"
                                                                        id="select_attribute" class="form-control">
                                                                        <option value="0" disabled> Chọn
                                                                            thêm thuộc
                                                                            tính
                                                                        </option>
                                                                        <% attributes.forEach(function(attribute, index){ %>
                                                                        <option id="op_<%=attribute.id%>"
                                                                            value="<%= attribute.id %>">
                                                                            <%= attribute.attribute_name %>
                                                                        </option>
                                                                        <%})%>
                                                                    </select>
                                                                </div>
                                                                <div class="col-sm-2">
                                                                    <button type="button" id="add_more_attribute"
                                                                        class="btn hor-grd btn-grd-primary"><i
                                                                            class="icofont icofont-plus-circle"></i>
                                                                    </button>
                                                                </div>
                                                            </div>
                                                            <script>
                                                                function getValue() {
                                                                    var checks = $('.checks');
                                                                    var str = '';
                                                                    for (i = 0; i < checks.length; i++) {
                                                                        if (checks[i].checked === true) {
                                                                            str += `${checks[i].value},`;
                                                                        }
                                                                    }
                                                                    $('#product_attributes_type02').val(str);
                                                                    var value = $('#product_attributes_type02').val();
                                                                    console.log('Danh sách dữ liệu của loại dữ liệu');
                                                                    console.log(value);
                                                                }
                                                            </script>
                                                            <div class="attribute_product">
                                                                <% attributeValueArr.forEach(function(attributeValueAr, index){ %>
                                                                <div class="form-group row"
                                                                    id="attr_<%= attributeValueAr[0].attribute_id %>"
                                                                    data-id="<%= attributeValueAr[0].attribute_id %>">
                                                                    <label
                                                                        class="col-sm-12 col-form-label attribute-label mb-3">
                                                                        <strong>
                                                                            <%= attributeValueAr[0].attribute_name  %>
                                                                        </strong>
                                                                        <div
                                                                            class="minus-button btn btn-danger btn-outline-danger float-right">
                                                                            <i class="icofont icofont-minus-circle"></i>
                                                                        </div>
                                                                    </label>
                                                                    <% attributeValueAr.forEach(function(attributeValueA, index){ %>
                                                                    <div
                                                                        class="attribute_list_<%= attributeValueA.id %> col-sm-12">
                                                                        <div class="form-check">
                                                                            <label class="form-check-label"
                                                                                for="product_attr<%= attributeValueA.id %>"><%= attributeValueA.name %></label>
                                                                            <input type="checkbox"
                                                                                class="checks form-check-input"
                                                                                onclick="getValue()"
                                                                                value="<%= attributeValueA.id %>"
                                                                                id="product_attr<%= attributeValueA.id %>">
                                                                        </div>
                                                                    </div>
                                                                    <% }) %>
                                                                </div>
                                                                <% }) %>
                                                                <!-- danh sách thuộc tính sản phẩm start -->
                                                                <% attributesValues.forEach(function(attributesValue, index){ %>
                                                                <!-- nếu thuộc tính có type = 2 thì đưa vào if / start -->
                                                                <% if(attributesValue.type == 1){ %>
                                                                <div class="form-group row"
                                                                    id="attr_<%= attributesValue.attribute_id %>"
                                                                    data-id="<%= attributesValue.attribute_id %>">
                                                                    <label class="font-weight-bold col-sm-3"
                                                                        for="product_meta_description">
                                                                        <strong> <%= attributesValue.attribute_name %>
                                                                        </strong>
                                                                    </label>
                                                                    <input type="text"
                                                                        value="<%= attributesValue.name %>"
                                                                        name="product_<%= attributesValue.attribute_id %>"
                                                                        class="form-control col-sm-7"
                                                                        placeholder="Nhập giá trị thuộc tính">
                                                                    <div class="col-sm-2">
                                                                        <button
                                                                            class="minus-button btn btn-danger btn-outline-danger float-right"><i
                                                                                class="icofont icofont-minus-circle"></i>
                                                                        </button>
                                                                    </div>
                                                                </div>
                                                                <% } %>
                                                                <!-- nếu thuộc tính có type = 2 thì đưa vào if / end -->
                                                                <% }) %> </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </form>
                                        <button type="submit" id="dropzoneEditProductSubmit"
                                            class="btn hor-grd btn-grd-success mt-4 mb-4">
                                            <span><i class="icofont icofont-save"></i></span>
                                            Lưu lại
                                        </button>
                                    </div>
                                    <!-- end add product info -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="styleSelector">
            </div>
        </div>
    </div>
</div>
<script>

    // thiết lập các dữ liệu thuộc tính loại 2 cho checked
    function setCheckValue() {
        var idtype02 = '<%= producidtype02 %>';
        var idtype02arr = idtype02.split(",");
        // thiết lập các thuộc tính loại 2 của sản phẩm checked.
        for (i = 0; i < idtype02arr.length; i++) {
            $(`#product_attr${idtype02arr[i]}`).attr('checked', 'checked')
        }
    }
    function setOptions() {
        var idAttribute = '<%= idtype02Arr %>';
        var idAttributeArr = idAttribute.split(",");
        var options = $('#select_attribute option');
        for (i = 0; i < idAttributeArr.length; i++) {
            $(`#op_${idAttributeArr[i]}`).attr('disabled', true);
        }
        // var valueSelect = $('#select_attribute').val();
        // if (!valueSelect) {
        //     return false;
        // }
        // $("#select_attribute option:selected").attr('disabled', true);
        // // đưa id thuộc tính lên cho server
        // getAttributeServer(valueSelect);
    }
    // lấy thông tin của id thuộc tính và gửi lên server.

    function fortmartType01Remove(id, idArr, element) {
        var index = idArr.indexOf(id.toString());
        if (index != -1) {
            idArr.splice(index, 1);
            element.val(JSON.stringify(idArr));
        }
    }
    $(document).ready(function () {
        // ==================================================================
        // thiết lập checkbox checked cho id loại 2
        setCheckValue();
        // ==================================================================
        // disabled các option mà thuộc tính đã có rồi.
        setOptions();

        var imageData = null;
        var ProductAttrArr = [];
        var id_attribues = [];

        // gán danh sách id loại 1 cho input form.
        var idTyoe01Element = $('#product_attributes_type01');
        var idType01 = idTyoe01Element.val();
        var idtype01Arr = idType01.split(",");
        idTyoe01Element.val(JSON.stringify(idtype01Arr));
        id_attribues = idtype01Arr;
        var type01 = function (id, name) {
            return `
        <div class="form-group row" id=attr_${id} data-id="${id}">
        <label class="font-weight-bold col-sm-3" for="product_meta_description">
            ${name}
        </label>
        <input type="text" name="product_${id}" class="form-control col-sm-7"
            placeholder="${name}">
            <div class="col-sm-2">
                <button class="minus-button btn btn-danger btn-outline-danger float-right"><i
                        class="icofont icofont-minus-circle"></i>
                </button>
        </div>
    </div>
    `
        }
        var type02 = function (id, name) {
            return `
        <div class="form-group row" id=attr_${id} data-id="${id}">
            <label class="col-sm-12 col-form-label attribute-label mb-3"> <strong>${name} </strong> 
                <div class="minus-button btn btn-danger btn-outline-danger float-right"><i
                        class="icofont icofont-minus-circle"></i>
                </div>
            </label>
            <div class="attribute_list_${id} col-sm-12">
            </div>
        </div>
    `
        }
        var type02_attributes = function (id, name) {
            return `
        <div class="form-check">
            <input type="checkbox"
                class="checks form-check-input" onclick="getValue()"  value="${id}" id="${id}" checked>
            <label class="form-check-label"
                for="${id}">${name}</label>
        </div>`
        }
        // gửi thông tin hình ảnh lên cho server và đưa về model.
        function updateProductImage(url) {
            $.ajax({
                url: url,
                type: 'GET',
                cache: false,
                contentType: false, // kiểu dữ liệu được đửa lên
                processData: false, // Set giá trị này là false nếu bạn không muốn dữ liệu được truyền vào thiết lập data sẽ được xử lý và biến thành một query kiểu chuỗi.
                success: function (result) {
                    $('#image-view').attr('src', `/public/uploads/products/${result.imageName}`);
                },
                error: function (error) {
                    console.log(error);
                }
            })
        }
        // thực hiện update hình ảnh của sản phẩm lên server
        function postProductImageUpdate(url, data) {
            $.ajax({
                url: url,
                type: 'POST',
                cache: false,
                contentType: false, // kiểu dữ liệu được đửa lên
                processData: false, // Set giá trị này là false nếu bạn không muốn dữ liệu được truyền vào thiết lập data sẽ được xử lý và biến thành một query kiểu chuỗi.
                data: data,
                success: function (result) {
                    var img = $(`#${result.idImage}`);
                    $('#image-edit-modal').modal('hide');
                    $('.theme-loader').fadeOut('slow', function () {
                        $(this).remove();
                    });
                    setTimeout(function () {
                        img.attr('src', `/public/uploads/products/${result.imageSrc}`);
                    }, 2000);
                    console.log(`id hỉnh ảnh:#${result.idImage}`);
                    console.log(`Đường dẫn hỉnh ảnh : /public/uploads/products/${result.imageSrc}`);
                    imageData = null;
                },
                error: function (error) {
                    console.log(error);
                }
            })
        }

        // lấy đường link truyển cho ajax
        $('.edit-product-image').bind('click', function () {
            var url = $(this).attr('data-url');
            $('#save-button-product-image-modal').attr('href', url);
            updateProductImage(url);
        });


        $('#save-button-product-image-modal').on('click', function (e) {
            e.preventDefault();
            var url = $(this).attr('href');
            postProductImageUpdate(url, imageData);
        })

        function getProductImageUpdate() {
            $('#product_image').bind('change', function () {
                let fileData = $(this)[0].files[0];
                let math = ["image/png", "image/jpg", "image/jpeg", "image/webp"];
                let limit = 1048576;  // 1 mb 

                // hàm inArray là dùng để chekc dữ liệu coi có trùng hay không.
                if ($.inArray(fileData.type, math) === -1) {
                    alertify.notify('Kiểu ảnh không hợp lệ, chỉ chấp nhận kiểu jpg hoặc png', 'error', 7);
                    $(this).val(null);
                    return false;
                }
                if (fileData.size > limit) {
                    console.log('Dung lượng ảnh quá lớn');
                    $(this).val(null);
                    return false;
                }
                // kiểm tra xem trình duyệt có hỗ trợ file reader hay không
                if (typeof (FileReader) != 'undefine') {

                    var fileReader = new FileReader();
                    // hình ảnh preview sau khi chọn file;
                    var image_preview = $('#image-view');
                    fileReader.onload = function (element) {
                        image_preview.attr('src', element.target.result);
                    }
                    var formData = new FormData(); // Currently empty
                    formData.append('product-image', fileData);
                    imageData = formData;

                    fileReader.readAsDataURL(fileData);
                }
            });
        }

        $('#trigger_button').on('click', function () {
            $('#product_image').trigger('click', getProductImageUpdate());
        });
        // expected output: "￥123,457"
        $("#product-edit-form").validate({
            rules: {
                product_name: {
                    required: true,
                    minlength: 2,
                },
                product_sku: {
                    required: true,
                    minlength: 5
                },
                product_price: {
                    required: true,
                    number: true
                },
                product_brand: {
                    required: true,
                },
                product_category: {
                    required: true
                }
            },
            messages: {
                product_name: {
                    required: "Vui lòng nhập tên sản phẩm",
                    minlength: "Tên sản phẩm phải có ít nhất 2 ký tự"
                },
                product_sku: {
                    required: "Vui lòng nhập mã sản phẩm",
                    minlength: "Mã sản phẩm phảo có ít nhất 2 ký tự"
                },
                product_price: {
                    required: "Vui lòng nhập giá sản phẩm",
                    number: 'giá sản phẩm phải là số'
                },
                product_brand: {
                    required: "Vui lòng chọn hãng sản xuất",
                },
                product_category: {
                    required: 'Vui lòng chọn danh mục cho sản phẩm'
                }
            }
        });

        // start ajax ==================
        function getAttributeServer(id) {
            $.ajax({
                url: '/admin/product/add-product-attribute/' + id,
                type: 'POST',
                cache: false,
                contentType: 'application/json',
                dataType: 'json',
                processData: false, // Set giá trị này là false nếu bạn không muốn dữ liệu được truyền vào thiết lập data sẽ được xử lý và biến thành một query kiểu chuỗi.
                data: JSON.stringify({ id: id }),
                success: function (result) {
                    // nếu loại sản phẩm là danh sách thì cho vào danh sách
                    if (result.type == 2) {
                        var attributes = result.attributes;
                        $('.attribute_product').append(type02(result.attribute_id, result.attribute_name));
                        var list_attributes = $(`.attribute_list_${result.id}`);
                        for (var index = 0; index < attributes.length; index++) {
                            list_attributes.append(type02_attributes(attributes[index].id, attributes[index].name));
                        }
                        // thêm id thuộc tính vào mảng html
                        ProductAttrArr.push(`attr_${result.attribute_id}`);
                        getValue();
                    } else {
                        // nếu loại danh sách là text thì cho vào loại text.
                        var attributes = result.attributes;
                        $('.attribute_product').append(type01(attributes[0].id, attributes[0].attribute_name));
                        var formcontrolAttribute = $('#product_attributes_type01').val();
                        ProductAttrArr.push(`attr_${result.attribute_id}`);
                        // trường hợp input đã có dữ liệu
                        if (formcontrolAttribute.length > 0) {
                            id_attribues = JSON.parse(formcontrolAttribute);
                            var idAdd = result.attribute_id;
                            id_attribues.push(id.toString());
                            idTyoe01Element.val(JSON.stringify(id_attribues));
                        } else {
                            // trường hợp input chưa có dữ liệu
                            id_attribues.push(attributes[0].id.toString());
                            id_attribues.splice(0,1);
                            idTyoe01Element.val(JSON.stringify(id_attribues));
                            console.log(idTyoe01Element.val());
                        }
                    }
                },
                error: function (error) {
                    notify(error, 'danger');
                }
            })
        }
        // end ajax ==================
        // start send attribute id ==================
        $('#add_more_attribute').on('click', function (e) {
            e.preventDefault();
            var options = $('#select_attribute option');
            var valueSelect = $('#select_attribute').val();
            if (!valueSelect) {
                return false;
            }
            $("#select_attribute option:selected").attr('disabled', true);
            // đưa id thuộc tính lên cho server
            getAttributeServer(valueSelect);
        });
        // end send attribute id ======================

        // start remove attribute id ==================
        $(document).on("click", ".minus-button", function (e) {
            e.preventDefault()
            var parent = $(this).parent().parent();
            var parentId = parent.attr('id');
            var idParentSelect = parent.attr('data-id');
            $("#select_attribute option[value=" + idParentSelect + "]").attr('disabled', false);
            $(`#${parentId}`).remove();
            getValue();
            fortmartType01Remove(idParentSelect, id_attribues, idTyoe01Element);
            // xóa id của attribute trước khi đưa lên server
        })
        // end remove attribute id ==================
    });
</script>

<%- include("../modal/image-edit-modal.ejs") %>